<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.prize.lottery.mapper.DltIcaiMapper">

    <resultMap id="DltICaiDataMap" type="com.prize.lottery.po.dlt.DltIcaiPo">
        <id column="id" property="id"/>
        <result column="period" property="period"/>
        <result column="master_id" property="masterId"/>
        <result column="calc_time" property="calcTime"/>
        <result column="gmt_create" property="gmtCreate"/>
        <association property="red1" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r1" property="data"/>
            <result column="hit_r1" property="hitData"/>
            <result column="r1_hit" property="dataHit"/>
        </association>
        <association property="red2" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r2" property="data"/>
            <result column="hit_r2" property="hitData"/>
            <result column="r2_hit" property="dataHit"/>
        </association>
        <association property="red3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r3" property="data"/>
            <result column="hit_r3" property="hitData"/>
            <result column="r3_hit" property="dataHit"/>
        </association>
        <association property="red10" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r10" property="data"/>
            <result column="hit_r10" property="hitData"/>
            <result column="r10_hit" property="dataHit"/>
        </association>
        <association property="red20" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r20" property="data"/>
            <result column="hit_r20" property="hitData"/>
            <result column="r20_hit" property="dataHit"/>
        </association>
        <association property="redKill3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="rk3" property="data"/>
            <result column="hit_rk3" property="hitData"/>
            <result column="rk3_hit" property="dataHit"/>
        </association>
        <association property="redKill6" javaType="com.prize.lottery.value.ForecastValue">
            <result column="rk6" property="data"/>
            <result column="hit_rk6" property="hitData"/>
            <result column="rk6_hit" property="dataHit"/>
        </association>
        <association property="blue1" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b1" property="data"/>
            <result column="hit_b1" property="hitData"/>
            <result column="b1_hit" property="dataHit"/>
        </association>
        <association property="blue2" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b2" property="data"/>
            <result column="hit_b2" property="hitData"/>
            <result column="b2_hit" property="dataHit"/>
        </association>
        <association property="blue6" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b6" property="data"/>
            <result column="hit_b6" property="hitData"/>
            <result column="b6_hit" property="dataHit"/>
        </association>
        <association property="blueKill3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="bk" property="data"/>
            <result column="hit_bk" property="hitData"/>
            <result column="bk_hit" property="dataHit"/>
        </association>
    </resultMap>

    <resultMap id="DltICaiHistoryMap" type="com.prize.lottery.vo.dlt.DltIcaiHistoryVo">
        <id column="id" property="id"/>
        <result column="period" property="period"/>
        <result column="master_id" property="masterId"/>
        <result column="calc_time" property="calcTime"/>
        <result column="gmt_create" property="gmtCreate"/>
        <result column="red" property="red"/>
        <result column="blue" property="blue"/>
        <association property="red1" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r1" property="data"/>
            <result column="hit_r1" property="hitData"/>
            <result column="r1_hit" property="dataHit"/>
        </association>
        <association property="red2" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r2" property="data"/>
            <result column="hit_r2" property="hitData"/>
            <result column="r2_hit" property="dataHit"/>
        </association>
        <association property="red3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r3" property="data"/>
            <result column="hit_r3" property="hitData"/>
            <result column="r3_hit" property="dataHit"/>
        </association>
        <association property="red10" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r10" property="data"/>
            <result column="hit_r10" property="hitData"/>
            <result column="r10_hit" property="dataHit"/>
        </association>
        <association property="red20" javaType="com.prize.lottery.value.ForecastValue">
            <result column="r20" property="data"/>
            <result column="hit_r20" property="hitData"/>
            <result column="r20_hit" property="dataHit"/>
        </association>
        <association property="redKill3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="rk3" property="data"/>
            <result column="hit_rk3" property="hitData"/>
            <result column="rk3_hit" property="dataHit"/>
        </association>
        <association property="redKill6" javaType="com.prize.lottery.value.ForecastValue">
            <result column="rk6" property="data"/>
            <result column="hit_rk6" property="hitData"/>
            <result column="rk6_hit" property="dataHit"/>
        </association>
        <association property="blue1" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b1" property="data"/>
            <result column="hit_b1" property="hitData"/>
            <result column="b1_hit" property="dataHit"/>
        </association>
        <association property="blue2" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b2" property="data"/>
            <result column="hit_b2" property="hitData"/>
            <result column="b2_hit" property="dataHit"/>
        </association>
        <association property="blue6" javaType="com.prize.lottery.value.ForecastValue">
            <result column="b6" property="data"/>
            <result column="hit_b6" property="hitData"/>
            <result column="b6_hit" property="dataHit"/>
        </association>
        <association property="blueKill3" javaType="com.prize.lottery.value.ForecastValue">
            <result column="bk" property="data"/>
            <result column="hit_bk" property="hitData"/>
            <result column="bk_hit" property="dataHit"/>
        </association>
    </resultMap>

    <resultMap id="IcaiRankedDataMap" type="com.prize.lottery.vo.ICaiRankedDataVo">
        <id column="id" property="id"/>
        <result column="rank" property="rank"/>
        <result column="period" property="period"/>
        <association property="master" javaType="com.prize.lottery.value.MasterValue">
            <result column="master_id" property="masterId"/>
            <result column="name" property="name"/>
        </association>
        <association property="data" javaType="com.prize.lottery.value.ForecastValue">
            <result column="data" property="data"/>
            <result column="data_hit" property="dataHit"/>
            <result column="hit_data" property="hitData"/>
        </association>
        <association property="neRate" javaType="com.prize.lottery.value.StatHitValue">
            <result column="ne_count" property="count"/>
            <result column="ne_rate" property="rate"/>
            <result column="ne_hit" property="series"/>
        </association>
        <association property="meRate" javaType="com.prize.lottery.value.StatHitValue">
            <result column="me_count" property="count"/>
            <result column="me_rate" property="rate"/>
            <result column="me_hit" property="series"/>
        </association>
        <association property="hiRate" javaType="com.prize.lottery.value.StatHitValue">
            <result column="hi_count" property="count"/>
            <result column="hi_rate" property="rate"/>
            <result column="hi_hit" property="series"/>
        </association>
    </resultMap>

    <resultMap id="DltCensusMap" type="com.prize.lottery.po.dlt.DltLottoCensusPo">
        <id column="id" property="id"/>
        <result column="period" property="period"/>
        <result column="type" property="type"/>
        <result column="level" property="level"/>
        <result column="channel" property="channel"/>
        <result column="census" property="census"/>
        <result column="gmt_create" property="gmtCreate"/>
    </resultMap>

    <resultMap id="SchemaRenewMasterMap" type="com.prize.lottery.vo.SchemaRenewMasterVo">
        <id column="master_id" property="masterId"/>
        <result column="period" property="period"/>
        <association property="master" javaType="com.prize.lottery.value.MasterValue">
            <result column="name" property="name"/>
            <result column="avatar" property="avatar"/>
        </association>
    </resultMap>

    <resultMap id="DltICaiHitVoMap" type="com.prize.lottery.vo.dlt.DltICaiHitVo">
        <id column="master_id" property="masterId"/>
        <result column="period" property="period"/>
        <result column="r3_hit" property="red3"/>
        <result column="r10_hit" property="red10"/>
        <result column="r20_hit" property="red20"/>
        <result column="rk3_hit" property="rk3"/>
        <result column="b6_hit" property="blue6"/>
        <result column="bk_hit" property="bk"/>
    </resultMap>

    <insert id="addDltICai" parameterType="com.prize.lottery.po.dlt.DltIcaiPo" useGeneratedKeys="true"
            keyProperty="id">
        insert
        ignore into dlt_icai(period,
                                    master_id,
                                    r1,
                                    r2,
                                    r3,
                                    r10,
                                    r20,
                                    rk3,
                                    rk6,
                                    b1,
                                    b2,
                                    b6,
                                    bk,
                                    gmt_create
                                   )
        values (
        #{period},
        #{masterId},
        #{red1.data},
        #{red2.data},
        #{red3.data},
        #{red10.data},
        #{red20.data},
        #{redKill3.data},
        #{redKill6.data},
        #{blue1.data},
        #{blue2.data},
        #{blue6.data},
        #{blueKill3.data},
        current_time
        )
    </insert>

    <update id="editDltICaiList" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            update dlt_icai
            set
            hit_r1=#{item.red1.hitData},
            r1_hit=#{item.red1.dataHit},
            hit_r2=#{item.red2.hitData},
            r2_hit=#{item.red2.dataHit},
            hit_r3=#{item.red3.hitData},
            r3_hit=#{item.red3.dataHit},
            hit_r10=#{item.red10.hitData},
            r10_hit=#{item.red10.dataHit},
            hit_r20=#{item.red20.hitData},
            r20_hit=#{item.red20.dataHit},
            hit_rk3=#{item.redKill3.hitData},
            rk3_hit=#{item.redKill3.dataHit},
            hit_rk6=#{item.redKill6.hitData},
            rk6_hit=#{item.redKill6.dataHit},
            hit_b1=#{item.blue1.hitData},
            b1_hit=#{item.blue1.dataHit},
            hit_b2=#{item.blue2.hitData},
            b2_hit=#{item.blue2.dataHit},
            hit_b6=#{item.blue6.hitData},
            b6_hit=#{item.blue6.dataHit},
            hit_bk=#{item.blueKill3.hitData},
            bk_hit=#{item.blueKill3.dataHit},
            calc_time=current_time
            where id=#{item.id}
        </foreach>
    </update>

    <sql id="dltICaiSql">
        id
        ,period,master_id,r1,r2,r3,r10,r20,rk3,rk6,b1,b2,b6,bk,gmt_create
    </sql>

    <sql id="dltHitInfoSql">
        id
        ,period,master_id,
        r1_hit,r2_hit,
        r3_hit,r10_hit,
        r20_hit,rk3_hit,
        rk6_hit,b1_hit,
        b2_hit,b6_hit,
        bk_hit,calc_time
    </sql>

    <sql id="dltHitDetailSql">
        id
        ,period,master_id,
        r1_hit,hit_r1,
        r2_hit,hit_r2,
        r3_hit,hit_r3,
        r10_hit,hit_r10,
        r20_hit,hit_r20,
        rk3_hit,hit_rk3,
        rk6_hit,hit_rk6,
        b1_hit,hit_b1,
        b2_hit,hit_b2,
        b6_hit,hit_b6,
        bk_hit,hit_bk,
        calc_time
    </sql>

    <select id="getDltICaiDataById" parameterType="java.lang.Long" resultMap="DltICaiDataMap">
        select
        <include refid="dltICaiSql"/>
        from
        dlt_icai
        where
        id=#{id}
    </select>

    <select id="getDltICaiData" resultMap="DltICaiDataMap">
        select
        <include refid="dltICaiSql"/>,calc_time
        from
        dlt_icai
        where
        period=#{period}
        and
        master_id=#{masterId}
    </select>

    <select id="getAllDltICaiDatas" parameterType="java.lang.String" resultMap="DltICaiDataMap">
        select
        <include refid="dltICaiSql"/>
        from
        dlt_icai
        where
        period=#{period}
    </select>

    <select id="getAllUnCalcDatas" parameterType="java.lang.String" resultMap="DltICaiDataMap">
        select
        <include refid="dltICaiSql"/>
        from
        dlt_icai
        where
        period=#{period}
        and calc_time is null
    </select>

    <select id="hasDltICaiData" parameterType="java.lang.String" resultType="java.lang.Integer">
        select
            count(1)
        from
            dlt_icai
        where
            period = #{period}
    </select>

    <select id="latestDltICaiPeriod" resultType="com.prize.lottery.value.Period">
        select
            period,
            if(calc_time is null, 0, 1) as calculated
        from
            dlt_icai
        order by
            period desc,
            id desc limit 1
    </select>

    <select id="latestDltMasterPeriod" parameterType="java.lang.String"
            resultType="com.prize.lottery.value.Period">
        select
            period,
            if(calc_time is null, 0, 1) as calculated
        from
            dlt_icai
        where
            master_id = #{masterId}
        order by
            period desc limit 1
    </select>

    <select id="getUnCalculatedPeriods" parameterType="java.lang.String" resultType="java.lang.String">
        select distinct
            period
        from
            dlt_icai
        where
              period &lt;= #{before}
          and calc_time is null
        order by
            period asc
    </select>

    <select id="getIncrUnCalculatedPeriods" resultType="java.lang.String">
        select distinct
            period
        from
            dlt_icai
        where
            calc_time is null
        order by
            period asc
    </select>

    <select id="getIncrUnCalcRatePeriods" resultType="java.lang.String">
        select distinct
            di.period
        from
            dlt_icai di
                left join dlt_master_rate drate on di.master_id = drate.master_id and di.period = drate.period
        where
              di.calc_time is not null
          and drate.id is null
    </select>

    <select id="getIncrUnCalcRateMasters" parameterType="java.lang.String" resultType="java.lang.String">
        select
            di.master_id
        from
            dlt_icai di
                left join dlt_master_rate drate on di.master_id = drate.master_id and di.period = drate.period
        where
              di.calc_time is not null
          and di.period = #{period}
          and drate.id is null
    </select>

    <select id="getUnCalcRatePeriods" resultType="java.lang.String">
        select distinct
            period
        from
            dlt_icai
        where
              calc_time is not null
          and period not in (
                                select distinct
                                    period
                                from
                                    dlt_master_rate
                                order by
                                    period asc
                            )
        order by
            period asc
    </select>

    <select id="hasDltPeriodOpenCalc" parameterType="java.lang.String" resultType="java.lang.Integer">
        select
            ifnull(
                    (
                        select
                            1
                        from
                            dlt_icai
                        where
                              period = #{period}
                          and calc_time is not null
                        limit 1 ), 0)
    </select>

    <select id="hasDltMasterOpenCalc" resultType="java.lang.Integer">
        select
            count(1)
        from
            dlt_icai
        where
              period = #{period}
          and master_id = #{masterId}
          and calc_time is not null
    </select>

    <select id="getDltMasterIdsByPeriod" parameterType="java.lang.String" resultType="java.lang.String">
        select
            master_id
        from
            dlt_icai
        where
            period = #{period}
    </select>

    <select id="getUnCalcDataPeriods" parameterType="java.lang.String" resultType="java.lang.String">
        select distinct
            period
        from
            dlt_icai
        where
              period &lt;= #{period}
          and calc_time is null
        order by
            period asc
    </select>

    <select id="getDltHighRateDatas" resultMap="DltICaiDataMap">
        select
            di.id,
            di.master_id,
            di.period,
            di.${type}
        from
            dlt_icai di,
            dlt_master_rate dm
        where
              di.period = #{period}
          and di.master_id = dm.master_id
          and dm.period = #{last}
          and dm.${type}_me_rate &gt;= #{rate}
    </select>

    <select id="getDltHotMasterDatas" resultMap="DltICaiDataMap">
        select
        <include refid="dltICaiSql"/>
        from dlt_icai
        where
        period=#{period}
        and
        master_id in(
        select
        master_id
        from dlt_master_rank dm
        where
        dm.period=#{last}
        and
        dm.hot=1
        order by `rank` desc
        )
    </select>

    <select id="getDltHotMasters" resultType="java.lang.String">
        select
            dm.master_id
        from
            dlt_master_rank dm,
            (
                select
                    count(1) as amount,
                    master_id
                from
                    dlt_master_rank
                where
                      is_vip = 1
                  and period &lt;= #{last}
                  and period &gt;= #{start}
                group by
                    master_id
            ) lm
        where
              dm.period = #{period}
          and dm.is_vip = 1
          and lm.master_id = dm.master_id
          and lm.amount &gt;= #{throttle}
    </select>

    <update id="extractDltHotMasters">
        update dlt_master_rank
        set
        hot=1
        where
        period=#{period}
        and master_id in
        <foreach collection="masterIds" item="masterId" separator="," open="(" close=")">
            #{masterId}
        </foreach>
    </update>

    <select id="getDltVipItemDatas" resultMap="DltICaiDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            di.${type},
            dmr.${type}_rank `rank`
        from
            dlt_icai di,
            dlt_master_rank dmr
        where
              di.period = #{period}
          and di.master_id = dmr.master_id
          and dmr.period = #{last}
          and dmr.is_vip = 1
        order by
            `rank` asc
    </select>

    <select id="getDltVipMasterDatas" resultMap="DltICaiDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            di.r1,
            di.r2,
            di.r3,
            di.r10,
            di.r20,
            di.rk3,
            di.rk6,
            di.b1,
            di.b2,
            di.b6,
            di.bk,
            dmr.rank `rank`
        from
            dlt_icai di,
            dlt_master_rank dmr
        where
              di.period = #{period}
          and di.master_id = dmr.master_id
          and dmr.period = #{last}
          and dmr.is_vip = 1
        order by
            `rank`
                desc
    </select>

    <select id="getAllDltRankedDatas" resultMap="IcaiRankedDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            di.${type}       data,
            dmr.${type}_rank `rank`
        from
            dlt_icai di,
            dlt_master_rank dmr
        where
              di.period = #{period}
          and di.master_id = dmr.master_id
          and dmr.period = #{last}
        order by
            `rank` asc
    </select>

    <select id="getLimitDltRankedDatas" resultMap="IcaiRankedDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            di.${type}       data,
            dmr.${type}_rank `rank`
        from
            dlt_icai di,
            dlt_master_rank dmr
        where
              di.period = #{period}
          and di.master_id = dmr.master_id
          and dmr.period = #{last}
        order by
            `rank` asc
            limit #{limit}
    </select>

    <select id="getDltComparedDatas" resultMap="IcaiRankedDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            mi.name,
            di.${type}             data,
            di.hit_${type}         hit_data,
            drate.${type}_ne_count ne_count,
            drate.${type}_ne_hit   ne_hit,
            drate.${type}_ne_rate  ne_rate,
            drate.${type}_me_count me_count,
            drate.${type}_me_hit   me_hit,
            drate.${type}_me_rate  me_rate,
            drate.${type}_hi_count hi_count,
            drate.${type}_hi_hit   hi_hit,
            drate.${type}_hi_rate  hi_rate,
            drank.${type}_rank     `rank`
        from
            dlt_icai di,
            master_info mi,
            dlt_master_rate drate,
            dlt_master_rank drank
        where
              di.period = #{period}
          and di.master_id = drate.master_id
          and di.master_id = drank.master_id
          and drate.period = #{last}
          and drank.period = #{last}
          and di.master_id = mi.seq
        order by
            `rank` asc
            limit #{limit}
    </select>

    <select id="getDltRankedDatas" parameterType="com.cloud.arch.page.PageCondition"
            resultMap="IcaiRankedDataMap">
        select
            di.id,
            di.period,
            di.master_id,
            mi.name,
            drank.is_vip,
            drank.hot,
            di.${condition.type}             data,
            di.${condition.type}_hit         data_hit,
            di.hit_${condition.type}         hit_data,
            drate.${condition.type}_ne_count ne_count,
            drate.${condition.type}_ne_hit   ne_hit,
            drate.${condition.type}_ne_rate  ne_rate,
            drate.${condition.type}_me_count me_count,
            drate.${condition.type}_me_hit   me_hit,
            drate.${condition.type}_me_rate  me_rate,
            drate.${condition.type}_hi_count hi_count,
            drate.${condition.type}_hi_hit   hi_hit,
            drate.${condition.type}_hi_rate  hi_rate,
            drank.${condition.type}_rank     `rank`
        from
            dlt_icai di,
            master_info mi,
            dlt_master_rate drate,
            dlt_master_rank drank
        where
              di.period = #{condition.period}
          and di.master_id = drate.master_id
          and di.master_id = drank.master_id
          and drate.period = #{condition.last}
          and drank.period = #{condition.last}
          and di.master_id = mi.seq
        order by
            `rank` asc
            limit
            #{offset},
            #{limit}
    </select>

    <select id="countDltRankedDatas" parameterType="com.cloud.arch.page.PageCondition"
            resultType="java.lang.Integer">
        select
            count(1)
        from
            dlt_icai di,
            dlt_master_rate dmr
        where
              di.period = #{condition.period}
          and dmr.period = #{condition.last}
          and di.master_id = dmr.master_id
    </select>

    <select id="getDltICaiHitsBefore" resultMap="DltICaiDataMap">
        select
        <include refid="dltHitInfoSql"/>
        from
        dlt_icai
        where
        master_id=#{masterId}
        and
        period &lt;=#{period}
        order by period desc
        limit #{limit}
    </select>

    <select id="getDltICaiHitsByPeriod" parameterType="java.lang.String" resultMap="DltICaiDataMap">
        select
        <include refid="dltHitInfoSql"/>
        from
        dlt_icai
        where
        period=#{period}
    </select>

    <select id="getHistoryDltForecasts" resultMap="DltICaiHistoryMap">
        select icai.*,
        li.red,
        li.blue
        from (
        select
        <include refid="dltHitDetailSql"/>
        from
        dlt_icai
        where
        master_id=#{masterId}
        and
        period &lt;=#{period}
        order by period desc
        limit #{limit}
        ) icai
        left join lottery_info li on li.period=icai.period and li.type='dlt'
    </select>

    <select id="getMasterDltICaiDetail" resultMap="DltICaiDataMap">
        select
        <include refid="dltHitDetailSql"/>,
        IF(calc_time is null,r1,'') as r1,
        IF(calc_time is null,r2,'') as r2,
        IF(calc_time is null,r3,'') as r3,
        IF(calc_time is null,r10,'') as r10,
        IF(calc_time is null,r20,'') as r20,
        IF(calc_time is null,rk3,'') as rk3,
        IF(calc_time is null,rk6,'') as rk6,
        IF(calc_time is null,b1,'') as b1,
        IF(calc_time is null,b2,'') as b2,
        IF(calc_time is null,b6,'') as b6,
        IF(calc_time is null,bk,'') as bk
        from
        dlt_icai
        where
        master_id=#{masterId}
        and
        period=#{period}
    </select>

    <select id="getDltICaiListByMasters" resultMap="DltICaiDataMap">
        select
        <include refid="dltHitDetailSql"/>,
        IF(calc_time is null,r1,'') as r1,
        IF(calc_time is null,r2,'') as r2,
        IF(calc_time is null,r3,'') as r3,
        IF(calc_time is null,r10,'') as r10,
        IF(calc_time is null,r20,'') as r20,
        IF(calc_time is null,rk3,'') as rk3,
        IF(calc_time is null,rk6,'') as rk6,
        IF(calc_time is null,b1,'') as b1,
        IF(calc_time is null,b2,'') as b2,
        IF(calc_time is null,b6,'') as b6,
        IF(calc_time is null,bk,'') as bk
        from
        dlt_icai
        where period=#{period}
        and master_id in
        <foreach collection="masters" item="masterId" separator="," open="(" close=")">
            #{masterId}
        </foreach>
    </select>

    <insert id="addDltCensuses" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        insert into
        dlt_census(period,`type`,channel,census,gmt_create,`level`)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.period},
            #{item.type},
            #{item.channel},
            #{item.census},
            current_time,
            <choose>
                <when test="item.level!=null">
                    #{item.level}
                </when>
                <otherwise>
                    0
                </otherwise>
            </choose>
            )
        </foreach>
        on duplicate key update
        census=values(census)
    </insert>

    <select id="getTypedDltCensusList" resultMap="DltCensusMap">
        select
            id,
            period,
            type,
            level,
            channel,
            census,
            gmt_create
        from
            dlt_census
        where
              period = #{period}
          and type = #{type}
        order by
            channel,
            level
    </select>

    <select id="getTypeLeveledCensusList" resultMap="DltCensusMap">
        select
            id,
            period,
            type,
            level,
            channel,
            census,
            gmt_create
        from
            dlt_census
        where
              period = #{period}
          and type = #{type}
          and level = #{level}
        order by
            id
    </select>

    <select id="getChannelDltCensusList" resultMap="DltCensusMap">
        select
            id,
            period,
            type,
            level,
            channel,
            census,
            gmt_create
        from
            dlt_census
        where
              period = #{period}
          and type = #{type}
          and channel = #{channel}
        order by
            level
    </select>

    <select id="latestDltCensusPeriod" parameterType="java.lang.Integer" resultType="java.lang.String">
        select
            period
        from
            dlt_census
        where
            type = #{type}
        order by
            period desc,
            id desc limit 1
    </select>

    <select id="getDltSchemaRenewMasters" resultMap="SchemaRenewMasterMap">
        select
            di.master_id,
            mi.name,
            mi.avatar,
            di.period
        from
            dlt_icai di,
            dlt_master_rank drank,
            master_info mi
        where
              di.period = #{period}
          and di.master_id = drank.master_id
          and drank.period = #{last}
          and mi.seq = di.master_id
          and di.calc_time is null
        order by
            drank.rank asc
            limit #{limit}
    </select>

    <select id="getDltLast10HitList" resultMap="DltICaiHitVoMap">
        select
            master_id,
            period,
            r3_hit,
            r10_hit,
            r20_hit,
            rk3_hit,
            b6_hit,
            bk_hit
        from
            dlt_icai
        where
              master_id = #{masterId}
          and period &lt;= #{period}
        order by
            period desc limit 10
    </select>

    <select id="getNoneDataMasters" parameterType="java.lang.String"
            resultType="com.prize.lottery.po.master.MasterLotteryPo">
        select
            ml.id        as id,
            ml.master_id as masterId,
            ml.source_id as sourceId,
            ml.source    as source,
            ml.type      as type
        from
            master_lottery ml
                left join dlt_icai di on di.master_id = ml.master_id and di.period = #{period}
        where
              ml.type = 'dlt'
          and di.id is null
        order by
            ml.master_id asc limit 280
    </select>

    <select id="getAllNoneDataMasters" parameterType="java.lang.String"
            resultType="com.prize.lottery.po.master.MasterLotteryPo">
        select
            ml.id        as id,
            ml.master_id as masterId,
            ml.source_id as sourceId,
            ml.source    as source,
            ml.type      as type
        from
            master_lottery ml
                left join dlt_icai di on di.master_id = ml.master_id and di.period = #{period}
        where
              ml.type = 'dlt'
          and di.id is null
        order by
            ml.master_id asc
    </select>

    <delete id="delDataList" parameterType="java.util.List">
        delete
        from dlt_icai
        where master_id in
        <foreach collection="list" item="masterId" separator="," open="(" close=")">
            #{masterId}
        </foreach>
    </delete>

</mapper>
